{% extends "base.html" %}
{% load static %}

{% block title %}Mi Perfil{% endblock %}

{% block content %}
<section class="container mx-auto max-w-5xl py-5">

  <!-- Cabecera de perfil -->
  <div class="card card-md mb-4">
    <div class="card-body d-flex flex-column flex-md-row align-items-start align-items-md-center justify-content-between gap-3">
      <div class="d-flex align-items-center gap-3">
        <div class="rounded-circle bg-light d-flex align-items-center justify-content-center"
             style="width:56px;height:56px;font-weight:700;color:#0f172a;">
          {{ request.user.first_name|first|default:"" }}{{ request.user.last_name|first|default:"" }}
        </div>
        <div>
          <div class="fw-semibold">{{ request.user.get_full_name|default:request.user.email }}</div>
          <div class="text-muted small">{{ request.user.email }}</div>
        </div>
      </div>

      <div class="d-flex gap-2 ms-md-auto">
        <a class="btn btn-outline" href="{% url 'agenda:agendar_cita' %}">Agendar nueva cita</a>
        <a class="btn btn-primary" href="{% url 'agenda:perfil_editar' %}">Actualizar</a>
      </div>
    </div>
  </div>

  <!-- Próximas Citas -->
  <div class="card card-md mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h5 m-0 d-flex align-items-center gap-2">
          <span aria-hidden="true" style="display:inline-block;width:18px;height:18px;">
            <svg viewBox="0 0 24 24" fill="none"><rect x="3" y="4" width="18" height="18" rx="3" stroke="currentColor"/><path d="M8 2v4M16 2v4M3 10h18" stroke="currentColor"/></svg>
          </span>
          Próximas Citas
        </h2>
        <span class="text-muted small">{{ proximas|length }} próxima(s)</span>
      </div>

      {% if proximas %}
        {% regroup proximas by fecha|date:"F Y" as proximas_by_month %}
        <div class="d-flex flex-column gap-3">
          {% for grupo in proximas_by_month %}
            <div class="mt-1">
              <div class="text-muted fw-semibold small mb-2">{{ grupo.grouper }}</div>

              <div class="d-flex flex-column gap-3">
                {% for c in grupo.list %}
                  <div class="border rounded-4 p-3">
                    <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">

                      <div class="flex-grow-1">
                        <div class="fw-semibold" style="color:var(--brand);">
                          {{ c.fecha|date:"d/m/Y" }} · {{ c.hora|time:"H:i" }}
                        </div>

                        <div class="mt-1">
                          <div class="fw-semibold">
                            {{ c.medico.nombre }} ({{ c.medico.especialidad.nombre }})
                          </div>
                          {% if c.motivo %}
                            <div class="text-muted small">{{ c.motivo }}</div>
                          {% else %}
                            <div class="text-muted small">—</div>
                          {% endif %}
                        </div>

                        <div class="mt-2">
                          <span class="badge {{ c.estado_badge_class }}">{{ c.estado_ui|capfirst }}</span>
                        </div>
                      </div>

                      <div class="ms-auto">
                        <form method="post" action="{% url 'agenda:cita_cancelar' c.id %}" class="cancel-form">
                          {% csrf_token %}
                          <button type="submit" class="btn btn-sm btn-ghost text-danger d-inline-flex align-items-center gap-1">
                            <span aria-hidden="true" style="display:inline-block;width:16px;height:16px;">
                              <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16M10 11v6M14 11v6M6 7l1 13a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2l1-13M9 7V5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2" stroke="currentColor"/></svg>
                            </span>
                            Cancelar
                          </button>
                        </form>
                      </div>

                    </div>
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted small">No tienes próximas citas.</div>
      {% endif %}
    </div>
  </div>

  <!-- Historial -->
  <div class="card card-md">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h2 class="h5 m-0 d-flex align-items-center gap-2">
          <span aria-hidden="true" style="display:inline-block;width:18px;height:18px;">
            <svg viewBox="0 0 24 24" fill="none"><path d="M5 4h9a4 4 0 0 1 4 4v12H9a4 4 0 0 0-4 4V4Z" stroke="currentColor"/></svg>
          </span>
          Historial de Citas
        </h2>
      </div>

      {% if historial %}
        <div class="d-flex flex-column gap-3">
          {% for c in historial %}
            <div class="border rounded-4 p-3">
              <div class="d-flex align-items-start justify-content-between gap-3 flex-wrap">
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ c.fecha|date:"d/m/Y" }} · {{ c.hora|time:"H:i" }}</div>
                  <div class="fw-semibold mt-1">
                    {{ c.medico.nombre }} ({{ c.medico.especialidad.nombre }})
                  </div>
                  {% if c.motivo %}
                    <div class="text-muted small">{{ c.motivo }}</div>
                  {% endif %}
                  <div class="mt-2">
                    <span class="badge {{ c.estado_badge_class }}">{{ c.estado_ui|capfirst }}</span>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted small">Sin historial de citas.</div>
      {% endif %}
    </div>
  </div>

</section>

{% block extra_js %}
<script>
  document.querySelectorAll('.cancel-form').forEach(function (f) {
    f.addEventListener('submit', function (e) {
      if (!confirm('¿Seguro que quieres cancelar esta cita?')) {
        e.preventDefault();
      }
    });
  });
</script>
{% endblock %}
{% endblock %}
